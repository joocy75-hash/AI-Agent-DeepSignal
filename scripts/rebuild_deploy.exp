#!/usr/bin/expect -f
# Complete redeploy with docker build

set timeout 600
set password "Vc8,xn7j_fjdnNGy"

spawn ssh root@158.247.245.197 {
cd /root/auto-dashboard

echo "=== Pulling latest code ==="
git pull

echo ""
echo "=== Rebuild backend only (faster) ==="
docker compose --env-file .env.production build --no-cache backend

echo ""
echo "=== Restart all services ==="
docker compose --env-file .env.production down
docker compose --env-file .env.production up -d

echo ""
echo "=== Waiting 45 seconds for services ==="
sleep 45

echo ""
echo "=== Container status ==="
docker compose --env-file .env.production ps

echo ""
echo "=== Backend logs (last 30 lines) ==="
docker compose --env-file .env.production logs backend --tail=30

echo ""
echo "=== Creating admin user ==="
docker exec trading-backend python -m src.scripts.create_admin_user 2>&1 || echo "Admin user info"
}

expect {
    "*password:*" {
        send "$password\r"
        exp_continue
    }
    eof
}
